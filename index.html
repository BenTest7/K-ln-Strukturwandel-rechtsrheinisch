<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Strukturwandel Köln – interaktive Rollenkarte (Mülheim-Fokus, SW-Hintergrund)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  header { padding:10px 12px; border-bottom:1px solid #ddd; background:#fff; }
  header h1 { font-size:16px; margin:0 0 6px; }
  header p { margin:0; font-size:12px; color:#444; line-height:1.25; }
  #map { height: calc(100% - 78px); width:100%; }

  /* Schwarz/Weiß-Look für Kacheln */
  .leaflet-tile { filter: grayscale(100%) contrast(115%) brightness(105%); }

  .roleBtn{
    display:block; width:100%;
    margin:6px 0; padding:10px 12px;
    font-size:14px; border-radius:10px;
    border:1px solid #ddd; background:#f7f7f7;
  }
  .roleBtn:active { transform: translateY(1px); }

  .pill {
    display:inline-block; padding:2px 8px; border-radius:999px;
    border:1px solid #ddd; background:#fafafa; font-size:11px; color:#333;
  }
</style>
</head>
<body>
<header>
  <h1>Strukturwandel Köln (rechtsrheinisch) – Rollenkarte</h1>
  <p>
    Hintergrund: <b>Schwarz/Weiß</b>. Klick auf eine Kachel → Rolle wählen: Industrie <b>(blau)</b>, Start-ups <b>(gelb)</b>, Wohnen <b>(rot)</b>, Freizeit/Kultur <b>(grün)</b>.
    <br><span class="pill">Fokus: Mülheim</span> (in mehrere Teilkacheln) · <span class="pill">Spezialkacheln</span>: Lanxess Arena, Carlswerk.
  </p>
</header>

<div id="map" aria-label="Interaktive Karte"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', { zoomControl: true }).setView([50.954, 7.010], 14);

// Basemap (schwarz/weiß über CSS)
const cartoPositron = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
  subdomains: 'abcd',
  maxZoom: 20,
  attribution: 'Map tiles by Carto, under CC BY 3.0. Data by OpenStreetMap, under ODbL.'
}).addTo(map);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap-Mitwirkende'
});

L.control.layers({
  "Carto Positron (SW)": cartoPositron,
  "OSM Standard (SW)": osm
}, null, {collapsed:true}).addTo(map);

// Rollen
const roleColors = {
  "Industrie": "blue",
  "Start-ups": "yellow",
  "Wohnen": "red",
  "Freizeit/Kultur": "green"
};

// localStorage
const STORAGE_KEY = "koeln_roles_muelheim_v1";
let saved = {};
try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch(e) { saved = {}; }
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(saved)); }

function box(lat, lon, dLat, dLon) {
  return [
    [lat - dLat, lon - dLon],
    [lat - dLat, lon + dLon],
    [lat + dLat, lon + dLon],
    [lat + dLat, lon - dLon]
  ];
}

function styleFor(name, important=false, special=false) {
  const role = saved[name];
  const fillColor = (role && roleColors[role]) ? roleColors[role] : "white";
  const fillOpacity = (role && roleColors[role]) ? 0.60 : 0.18;
  const weight = special ? 4 : (important ? 3 : 2);
  return { color:"#111", weight, fillColor, fillOpacity };
}

function popupHTML(name) {
  return `
    <b>${name}</b><br>
    <button class="roleBtn" onclick="setRole('${name}','Industrie')">Industrie (blau)</button>
    <button class="roleBtn" onclick="setRole('${name}','Start-ups')">Start-ups (gelb)</button>
    <button class="roleBtn" onclick="setRole('${name}','Wohnen')">Wohnen (rot)</button>
    <button class="roleBtn" onclick="setRole('${name}','Freizeit/Kultur')">Freizeit/Kultur (grün)</button>
    <button class="roleBtn" onclick="clearRole('${name}')">Keine Zuordnung</button>
  `;
}

const layers = {};

window.setRole = function(name, role) {
  saved[name] = role; save();
  if (layers[name]) layers[name].setStyle(styleFor(name, layers[name].__important, layers[name].__special));
  if (layers[name]) layers[name].closePopup();
};
window.clearRole = function(name) {
  delete saved[name]; save();
  if (layers[name]) layers[name].setStyle(styleFor(name, layers[name].__important, layers[name].__special));
  if (layers[name]) layers[name].closePopup();
};

function addTile(name, coords, opts={}) {
  const important = !!opts.important;
  const special = !!opts.special;
  const poly = L.polygon(coords, styleFor(name, important, special)).addTo(map);
  poly.__important = important;
  poly.__special = special;
  poly.bindPopup(popupHTML(name), {maxWidth: 280});
  poly.on('click', () => poly.openPopup()); // Farbauswahl sofort
  layers[name] = poly;
  return poly;
}

// Rechtsrheinisch (grobe Kacheln)
addTile("Deutz (gesamt)", box(50.9388, 6.9945, 0.0065, 0.0120));
addTile("Kalk (gesamt)",  box(50.9405, 7.0300, 0.0075, 0.0150));
addTile("Buchheim",       box(50.9530, 7.0220, 0.0048, 0.0100));
addTile("Buchforst",      box(50.9500, 7.0120, 0.0043, 0.0080));
addTile("Poll",           box(50.9195, 7.0120, 0.0060, 0.0120));

// Mülheim-Fokus (Teil-Kacheln)
addTile("Mülheim – Rheinfront", box(50.9570, 7.0080, 0.0048, 0.0100), {important:true});
addTile("Mülheim – Wiener Platz / Zentrum", box(50.9610, 7.0105, 0.0042, 0.0080), {important:true});
addTile("Mülheim – Schanzenstraße / Kreativcluster", box(50.9560, 7.0170, 0.0040, 0.0065), {important:true});
addTile("Mülheim – Keupstraße / Handel & Migration", box(50.9590, 7.0235, 0.0038, 0.0070), {important:true});
addTile("Mülheim – Nord / Wohnen", box(50.9670, 7.0150, 0.0045, 0.0100), {important:true});

// Spezialkacheln
addTile("Lanxess Arena (Spezial)", box(50.9386, 6.9822, 0.0012, 0.0018), {special:true});
addTile("Carlswerk (Spezial)",     box(50.9546, 7.0149, 0.0012, 0.0018), {special:true});

// Fokus-Bounds
const focusBounds = L.latLngBounds([[50.946, 6.982],[50.973, 7.035]]);
map.fitBounds(focusBounds, {padding:[20,20]});

// Tools
const tools = L.control({position:'topright'});
tools.onAdd = function() {
  const div = L.DomUtil.create('div', 'leaflet-bar');
  div.style.background = 'rgba(255,255,255,0.92)';
  div.style.padding = '8px';
  div.style.borderRadius = '10px';
  div.style.border = '1px solid #ddd';
  div.style.boxShadow = '0 10px 26px rgba(0,0,0,.08)';
  div.style.minWidth = '170px';
  div.innerHTML = `
    <div style="font-size:12px; color:#333; margin-bottom:6px;"><b>Tools</b></div>
    <button id="btnResetView" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; font-size:13px; margin:4px 0; cursor:pointer;">Ansicht zurück</button>
    <button id="btnResetColors" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; font-size:13px; margin:4px 0; cursor:pointer;">Farben zurücksetzen</button>
    <button id="btnExport" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; font-size:13px; margin:4px 0; cursor:pointer;">Export (Text)</button>
    <div style="margin-top:6px; font-size:11px; color:#666; line-height:1.25;">
      Klick auf Kachel → Rolle wählen. Speicherung pro Gerät.
    </div>
  `;
  L.DomEvent.disableClickPropagation(div);
  return div;
};
tools.addTo(map);

function resetView(){ map.fitBounds(focusBounds, {padding:[20,20]}); }
function resetColors(){
  saved = {}; save();
  Object.keys(layers).forEach(n => layers[n].setStyle(styleFor(n, layers[n].__important, layers[n].__special)));
}
function exportText(){
  const out = Object.keys(layers).sort().map(n => ({gebiet:n, rolle: saved[n] || ""}));
  const txt = JSON.stringify(out, null, 2);
  prompt("Kopiere den Export-Text (Copy):", txt);
}

document.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'btnResetView') resetView();
  if(e.target && e.target.id === 'btnResetColors') resetColors();
  if(e.target && e.target.id === 'btnExport') exportText();
});
</script>
</body>
</html>
